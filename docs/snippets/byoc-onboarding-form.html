<form id="byoc-onboarding-form" class="generator-form md-typeset" action="javascript:"
      onchange="updateFields()"
      onsubmit="generateConfigs()">
  <p>
    <label>
      <span>(1) Token type</span>
      <select id="byoc-onboarding-token-type">
        <option value="erc20">ERC20</option>
        <option value="native">Native token</option>
      </select>
    </label>
  </p>
  <p>
    <label>
      <span>(2) Integrated chain</span>
      <select id="byoc-onboarding-chain">
        <option value="Ethereum">Ethereum</option>
        <option value="Polygon">Polygon</option>
        <option value="BnbSmartChain">BNB Smart Chain</option>
      </select>
    </label>
  </p>

  <p>
    <label for="byoc-onboarding-implementation-payload">
      <span>(3) Payload for deploying implementation contract:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-implementation-payload" readonly>
  </p>
  <div class="button-container">
    <button type="button" class="md-button" onclick="deployImplementation()">Deploy with Metamask
    </button>
  </div>
  <p>
    <label for="byoc-onboarding-implementation-address">
      <span>(4) Deployed implementation contract address:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-implementation-address">
  </p>

  <p>
    <label for="byoc-onboarding-price">
      <span>(4) Current price:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-price">
  </p>
  <p class="erc20">
    <label for="byoc-onboarding-erc20">
      <span>(4) ERC20 contract:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-erc20">
  </p>
  <p class="erc20">
    <label for="byoc-onboarding-erc20-decimals">
      <span>(4) ERC20 decimals:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-erc20-decimals">
  </p>

  <p>
    <label for="byoc-onboarding-proxy-payload">
      <span>(5) Payload for deploying proxy contract:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-proxy-payload">
  </p>
  <div class="button-container">
    <button type="button" class="md-button" onclick="deployProxy()">Deploy with Metamask</button>
  </div>

  <p>
    <label for="byoc-onboarding-proxy-address">
      <span>(6) Deployed proxy contract address:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-proxy-address">
  </p>

  <p>
    <label>
      <span>(6) Is stable coin?</span>
      <select onchange="changeStableCoin()" id="byoc-onboarding-is-stable-coin">
        <option value="no">No</option>
        <option value="yes">Yes</option>
      </select>
    </label>
  </p>
  <p class="price-oracle-info">
    <label for="byoc-onboarding-reference-contract">
      <span>(6) Chain link reference contract:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-reference-contract">
  </p>
  <p class="price-oracle-info">
    <label for="byoc-onboarding-reference-symbols">
      <span>(6) Chain link contract decimals:</span>
    </label>
    <input class="md-input md-input--stretch" id="byoc-onboarding-reference-symbols">
  </p>

  <div>
    <p>
      <label for="byoc-onboarding-vote-payload">
        <span>(7) Update RPC for vote on Partisia Blockchain:</span>
      </label>
      <input class="md-input md-input--stretch" id="byoc-onboarding-vote-payload">
    </p>
  </div>

</form>

<script>

  function isNativeToken() {
    return document.getElementById("byoc-onboarding-token-type").value === "native";
  }

  function changeTokenType() {
    const form = document.getElementById("byoc-onboarding-form");
    form.classList.toggle("native-token", isNativeToken());
  }

  function isStableCoin() {
    return document.getElementById("byoc-onboarding-is-stable-coin").value === "yes";
  }

  function changeStableCoin() {
    const form = document.getElementById("byoc-onboarding-form");
    form.classList.toggle("stable-coin", isStableCoin());
  }

  function updateFields() {
    changeTokenType();
    changeStableCoin();

  }

  function deployImplementation() {
    deployThroughMetamask("byoc-onboarding-implementation-payload");
  }

  function deployProxy() {
    deployThroughMetamask("byoc-onboarding-proxy-payload");
  }

  function readIntegratedChain() {
    return document.getElementById("byoc-onboarding-chain").value;
  }

  function deployThroughMetamask(inputId) {
    const chainIds = {
      "Ethereum": "0x1",
      "BnbSmartChain": "0x38",
      "Polygon": "0x89"
    }
    const chainId = chainIds[readIntegratedChain()];
    const bytecode = document.getElementById(inputId).value;
    if (bytecode.length === 0) {
      window.alert("Payload has not been generated yet.");
      return;
    }
    window.ethereum.request({
      "method": "wallet_switchEthereumChain",
      "params": [
        {
          "chainId": chainId,
        },
      ],
    })
    .then(() => window.ethereum.request({method: "eth_requestAccounts"}))
    .then(a => {
      let account = a[0];
      return window.ethereum.request({
        method: "eth_sendTransaction",
        params: [
          {
            from: account,
            data: "0x" + bytecode,
          },
        ],
      })
      .then(() => window.alert("Deployment sent - follow transaction through metamask to determine contract address"))
      .catch((error) => window.alert("An error occurred: " + error.message));
    });
  }

  function generateConfigs() {
    // TOOD hardcode contract bytecode
    const proxyByteCode = document.getElementById("byoc-onboarding-proxy-byte-code").value;
    const implementationByteCode =
        document.getElementById("byoc-onboarding-implementation-byte-code").value;
    const chain = document.getElementById("byoc-onboarding-chain").value;
    const price = document.getElementById("byoc-onboarding-price").value;
    const referenceContract = document.getElementById("byoc-onboarding-reference-contract").value;
    const referenceSymbols = document.getElementById("byoc-onboarding-reference-symbols").value;
    const erc20 = document.getElementById("byoc-onboarding-erc20").value;
    const erc20Decimals = document.getElementById("byoc-onboarding-erc20-decimals").value;

    const implementationAddress =
        document.getElementById("byoc-onboarding-implementation-address").value;
    const proxyAddress = document.getElementById("byoc-onboarding-proxy-address").value;

    // 0000000000000000000000000000000000000000000000000000000000000040
    // 0000000000000000000000000000000000000000000000000000000000000124
    // f358ec61
    // 000000000000000000000000000000000000000000000000002386f26fc10000
    // 0000000000000000000000000000000000000000000000015af1d78b58c40000
    // 000000000000000000000000000000000000000000000002b5e3af16b1880000
    // 00000000000000000000000000000000000000000000000000000000000000a0
    // 0000000000000000000000003435359df1d8c126ea1b68bb51e958fdf43f8272
    // 0000000000000000000000000000000000000000000000000000000000000003
    // 0000000000000000000000008602d071adee3a1cd7085d171617b28c55326111
    // 0000000000000000000000000c89fb1401804b4434b6642e3b5ec49c1466fd23
    // 000000000000000000000000116d801bb5841fa1b9fec77b141d06ddc2754945
    // 00000000000000000000000000000000000000000000000000000000

    // Non ERC20
    //f358ec61
    // 0000000000000000000000000000000000000000000000000000000000000001
    // 0000000000000000000000000000000000000000000000000000000000000002
    // 0000000000000000000000000000000000000000000000000000000000000003
    // 00000000000000000000000000000000000000000000000000000000000000a0
    // 000000000000000000000000bcf8b2afc36214d9fc687d5a37de5e12fda55c23
    // 0000000000000000000000000000000000000000000000000000000000000000

    //347b6398
    // 000000000000000000000000bcf8b2afc36214d9fc687d5a37de5e12fda55c23
    // 0000000000000000000000000000000000000000000000000000000000000002
    // 0000000000000000000000000000000000000000000000000000000000000003
    // 0000000000000000000000000000000000000000000000000000000000000004
    // 00000000000000000000000000000000000000000000000000000000000000c0
    // 000000000000000000000000bcf8b2afc36214d9fc687d5a37de5e12fda55c23
    // 0000000000000000000000000000000000000000000000000000000000000000
    const deployImplementationPayload = implementationByteCode;

    console.log(erc20);
    let functionHeader;
    let offset;
    let decimals;
    if (!isNativeToken()) {
      functionHeader = "347b6398" + pad(erc20);
      offset = "c0";
      decimals = Number(erc20Decimals);
    } else {
      functionHeader = "f358ec61";
      offset = "a0";
      decimals = 18;
    }

    const indexOf = price.indexOf(".");
    let priceDecimals = 0;
    let priceBigInt;
    if (indexOf > -1) {
      const withoutDecimalPoint = price.replace(".", "");
      priceDecimals = withoutDecimalPoint.length - indexOf;
      priceBigInt = BigInt(withoutDecimalPoint);
    } else {
      priceDecimals = 0;
      priceBigInt = BigInt(price);
    }

    function valueToCoins(value) {
      const coinsBigInt = BigInt(value) * (BigInt(10) ** BigInt(decimals + priceDecimals))
          / priceBigInt;
      return coinsBigInt.toString(16);
    }

    const withdrawMin = valueToCoins(25);
    const withdrawMax = valueToCoins(200000);
    const depositMin = withdrawMin;
    const depositMax = valueToCoins(100000);
    const largeOracleContract = "0";
    let encodedInit = functionHeader + pad(depositMin) + pad(depositMax)
        + pad(withdrawMax) + pad(offset) + pad(largeOracleContract) + pad("0");
    const deployProxyByteCode =
        proxyByteCode
        + pad(implementationAddress)
        + "0000000000000000000000000000000000000000000000000000000000000040"
        + pad((encodedInit.length / 2).toString(16))
        + encodedInit;
    //const foo = 160; // 0xa0
    //const foo = 192; // 0xc0
    console.log(deployProxyByteCode);

    //TODO Generate vote payload

    // 000000000000000000000000bcf8b2afc36214d9fc687d5a37de5e12fda55c23
    // 0000000000000000000000000000000000000000000000000000000000000040
    // 0000000000000000000000000000000000000000000000000000000000000124
    // f358ec61
    // 000000000000000000000000000000000000000000000000002386f26fc10000
    // 0000000000000000000000000000000000000000000000015af1d78b58c40000
    // 000000000000000000000000000000000000000000000002b5e3af16b188000000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000003435359df1d8c126ea1b68bb51e958fdf43f827200000000000000000000000000000000000000000000000000000000000000030000000000000000000000008602d071adee3a1cd7085d171617b28c553261110000000000000000000000000c89fb1401804b4434b6642e3b5ec49c1466fd23000000000000000000000000116d801bb5841fa1b9fec77b141d06ddc275494500000000000000000000000000000000000000000000000000000000

  }

  function pad(value) {
    if (value.startsWith("0x")) {
      value = value.substr(2);
    }
    return value.padStart(64, "0");
  }

</script>
